<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estrattore Turni Professional</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f0f2f5; color: #333; }
        .container { max-width: 800px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { color: #1a73e8; text-align: center; }
        .upload-box { border: 2px dashed #ccc; padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center; background: #fafafa; }
        .upload-box:hover { border-color: #1a73e8; }
        label { font-weight: bold; display: block; margin-bottom: 10px; }
        button { background: #1a73e8; color: white; border: none; padding: 15px; border-radius: 6px; cursor: pointer; width: 100%; font-size: 1.1rem; font-weight: bold; }
        button:disabled { background: #ccc; }
        #log { margin-top: 20px; padding: 15px; background: #333; color: #00ff00; border-radius: 6px; font-family: monospace; font-size: 0.85rem; max-height: 200px; overflow-y: auto; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>Parser Turni v2.0</h1>
    
    <div class="upload-box">
        <label>1. Carica il file delle Rotazioni (.txt)</label>
        <input type="file" id="rotTxt" accept=".txt">
    </div>

    <div class="upload-box">
        <label>2. Carica il PDF completo dei Turni</label>
        <input type="file" id="pdfFile" accept="application/pdf">
    </div>

    <button id="startBtn">Genera Database JSON</button>

    <div id="log"></div>
</div>

<script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    const logDiv = document.getElementById('log');
    function addLog(msg) {
        logDiv.style.display = 'block';
        logDiv.innerHTML += "> " + msg + "<br>";
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    document.getElementById('startBtn').addEventListener('click', async () => {
        const rotFile = document.getElementById('rotTxt').files[0];
        const pdfFile = document.getElementById('pdfFile').files[0];

        if (!rotFile || !pdfFile) {
            alert("Carica entrambi i file per procedere.");
            return;
        }

        logDiv.innerHTML = "";
        addLog("Lettura file rotazioni...");
        
        const rotText = await rotFile.text();
        // Estraiamo tutti i codici ignorando le intestazioni e le virgole
        const regexCodice = /(\d+[a-zA-Z]\d+)/g;
        const codiciTrovati = [...new Set(rotText.match(regexCodice))];
        
        addLog("Codici unici individuati nella rotazione: " + codiciTrovati.length);

        const codiciMappati = codiciTrovati.map(c => {
            const parts = c.match(/^(\d+)[a-zA-Z](\d+)$/);
            return { originale: c.toUpperCase(), linea: parts[1], turno: parseInt(parts[2], 10).toString() };
        });

        addLog("Inizio analisi PDF...");
        const arrayBuffer = await pdfFile.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
        let dbTurni = {};

        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            const text = content.items.map(item => item.str).join(" ");
            
            const lineaMatch = text.match(/Linea:\s*(\d+\.?\d*)/i);
            const turnoMatch = text.match(/TURNO:\s*(\d+)Â°/i);

            if (lineaMatch && turnoMatch) {
                const lPDF = lineaMatch[1];
                const tPDF = turnoMatch[1];

                const matchCodice = codiciMappati.find(c => c.linea === lPDF && c.turno === tPDF);

                if (matchCodice) {
                    const mMatch = text.match(/MONTA\s+alle\s+([A-Z.\s]+)\s+(\d{1,2}\.\d{2})/i);
                    const sMatch = text.match(/SMONTA\s+([A-Z.\s]+)\s+alle\s+(\d{1,2}\.\d{2})/i);

                    if (mMatch && sMatch) {
                        dbTurni[matchCodice.originale] = {
                            inizio: mMatch[2].replace('.', ':'),
                            luogoInizio: mMatch[1].trim(),
                            fine: sMatch[2].replace('.', ':'),
                            luogoFine: sMatch[1].trim()
                        };
                        addLog("Estratto: " + matchCodice.originale);
                    }
                }
            }
        }

        addLog("Analisi terminata. Generazione file...");
        const blob = new Blob([JSON.stringify(dbTurni, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "database_turni.json";
        a.click();
        addLog("File scaricato con successo.");
    });
</script>
</body>
</html>
