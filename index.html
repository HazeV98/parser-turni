<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parser Turni ATVO v2.3</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f0f2f5; color: #333; }
        .container { max-width: 850px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { color: #1a73e8; text-align: center; margin-bottom: 25px; }
        .upload-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .upload-box { border: 2px dashed #bbb; padding: 15px; border-radius: 8px; text-align: center; background: #fafafa; }
        button { background: #1a73e8; color: white; border: none; padding: 15px; border-radius: 6px; cursor: pointer; width: 100%; font-size: 1.1rem; font-weight: bold; }
        #log { margin-top: 20px; padding: 15px; background: #1e1e1e; color: #00ff00; border-radius: 6px; font-family: 'Consolas', monospace; font-size: 0.8rem; height: 350px; overflow-y: auto; white-space: pre-wrap; border: 2px solid #333; }
        .log-err { color: #ff4444; }
        .log-ok { color: #00ff00; }
        .log-info { color: #888; }
    </style>
</head>
<body>

<div class="container">
    <h1>Parser Turni v2.3</h1>
    
    <div class="upload-section">
        <div class="upload-box">
            <label>1. <b>rotazioni.txt</b></label><br><br>
            <input type="file" id="rotTxt" accept=".txt">
        </div>
        <div class="upload-box">
            <label>2. <b>PDF Turni</b></label><br><br>
            <input type="file" id="pdfFile" accept="application/pdf">
        </div>
    </div>

    <button id="startBtn">Avvia Analisi Profonda</button>

    <div id="log">Pronto. Carica i file e premi Avvia...</div>
</div>

<script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    const logDiv = document.getElementById('log');
    function addLog(msg, type = '') {
        const span = document.createElement('span');
        span.className = type;
        span.innerText = "\n> " + msg;
        logDiv.appendChild(span);
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    function parseCodice(codice) {
        codice = codice.toLowerCase().trim();
        if (codice === 'disp' || codice.length < 3) return null;

        let matchM = codice.match(/^([a-z]\d)(\d+)$/);
        if (matchM) return { originale: codice.toUpperCase(), linea: matchM[1], turno: parseInt(matchM[2], 10).toString() };

        let matchStd = codice.match(/^(\d+)[a-z](\d+)$/);
        if (matchStd) return { originale: codice.toUpperCase(), linea: matchStd[1], turno: parseInt(matchStd[2], 10).toString() };

        return null;
    }

    document.getElementById('startBtn').addEventListener('click', async () => {
        const rotFile = document.getElementById('rotTxt').files[0];
        const pdfFile = document.getElementById('pdfFile').files[0];

        if (!rotFile || !pdfFile) { alert("Seleziona entrambi i file!"); return; }

        logDiv.innerText = "--- INIZIO ANALISI ---";
        const rotText = await rotFile.text();
        const codiciEstratti = rotText.match(/([a-zA-Z0-9]+)/g) || [];
        const mappaUnica = Array.from(new Set(codiciEstratti.map(c => JSON.stringify(parseCodice(c))))).map(s => JSON.parse(s)).filter(c => c !== null);

        addLog("Codici da trovare: " + mappaUnica.length, "log-info");

        const arrayBuffer = await pdfFile.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
        let dbTurni = {};

        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            const text = content.items.map(item => item.str).join(" ").replace(/\s+/g, " ");
            
            // Estrazione super-flessibile: cerca la parola Linea e un numero vicino, e Turno e un numero vicino
            const lineaRaw = text.match(/Linea:?\s*([a-z0-9.]+)/i);
            const turnoRaw = text.match(/TURNO:?\s*(\d+)/i);

            if (lineaRaw && turnoRaw) {
                const lPDF = lineaRaw[1].toLowerCase().split('.')[0]; // Prende '4' da '4.1'
                const tPDF = parseInt(turnoRaw[1], 10).toString();

                const coincidenze = mappaUnica.filter(c => c.linea.toLowerCase() === lPDF && c.turno === tPDF);

                if (coincidenze.length > 0) {
                    // Ricerca MONTA e SMONTA con pattern multipli
                    const monta = text.match(/MONTA\s+(?:alle\s+)?(.*?)\s+(\d{1,2}\.\d{2})/i);
                    const smonta = text.match(/SMONTA\s+(?:alle\s+)?(.*?)\s+(\d{1,2}\.\d{2})/i);

                    if (monta && smonta) {
                        coincidenze.forEach(target => {
                            dbTurni[target.originale] = {
                                inizio: monta[2].replace('.', ':'),
                                luogoInizio: monta[1].replace(/alle/gi, '').trim(),
                                fine: smonta[2].replace('.', ':'),
                                luogoFine: smonta[1].replace(/alle/gi, '').trim()
                            };
                            addLog("TROVATO: " + target.originale + " a pag. " + i, "log-ok");
                        });
                    }
                }
            } else {
                if(i < 5) addLog("Pagina " + i + " non sembra contenere un turno (manca header)", "log-info");
            }
        }

        if (Object.keys(dbTurni).length > 0) {
            const blob = new Blob([JSON.stringify(dbTurni, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "database_turni.json";
            a.click();
            addLog("\nSUCCESSO! Database generato.", "log-ok");
        } else {
            addLog("\nERRORE: Nessun match. Il PDF potrebbe avere un formato testo non leggibile correttamente.", "log-err");
        }
    });
</script>
</body>
</html>
