<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parser Turni v2.6</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f0f4f8; color: #2d3748; }
        .container { max-width: 850px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        h1 { color: #2b6cb0; text-align: center; margin-bottom: 25px; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
        .upload-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .box { border: 2px dashed #a0aec0; padding: 20px; border-radius: 10px; text-align: center; background: #fafafa; transition: 0.2s; }
        .box:hover { border-color: #2b6cb0; background: #f7fafc; }
        button { background: #2b6cb0; color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; width: 100%; font-size: 1.1rem; font-weight: bold; }
        button:disabled { background: #cbd5e0; }
        #log { margin-top: 20px; padding: 15px; background: #1a202c; color: #48bb78; border-radius: 8px; font-family: 'Consolas', monospace; font-size: 0.85rem; height: 350px; overflow-y: auto; white-space: pre-wrap; border: 1px solid #2d3748; }
        .progress-bar { height: 8px; background: #edf2f7; border-radius: 4px; margin: 15px 0; display: none; overflow: hidden; }
        #progressFill { height: 100%; background: #48bb78; width: 0%; transition: width 0.1s; }
    </style>
</head>
<body>

<div class="container">
    <h1>Parser Turni v2.6 (Precisione)</h1>
    
    <div class="upload-section">
        <div class="box">
            <label>1. <b>rotazioni.txt</b></label><br><br>
            <input type="file" id="rotTxt" accept=".txt">
        </div>
        <div class="box">
            <label>2. <b>PDF Turni</b></label><br><br>
            <input type="file" id="pdfFile" accept="application/pdf">
        </div>
    </div>

    <button id="startBtn">Analizza ed Estrai</button>
    
    <div class="progress-bar" id="pBar"><div id="progressFill"></div></div>
    <div id="log">Pronto. Carica i file e premi il tasto.</div>
</div>

<script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    function addLog(msg) {
        const log = document.getElementById('log');
        log.innerText += "\n> " + msg;
        log.scrollTop = log.scrollHeight;
    }

    function pulisciLuogo(t) {
        if(!t) return "";
        // Rimuove tutto ciò che NON è il nome del luogo
        return t.replace(/MONTA|SMONTA|alle|DURATA|Servizio|Validità|Tipologia|INTERO|PICCOLE|UNITA'|[0-9]{1,2}\.[0-9]{2}|[_\-]{2,}/gi, '')
                .replace(/\s+/g, ' ').trim();
    }

    function parseCodice(c) {
        c = c.toLowerCase().trim();
        let m = c.match(/^([a-z]\d)(\d+)$/); // M204
        if (m) return { or: c.toUpperCase(), l: m[1], t: parseInt(m[2], 10).toString() };
        let s = c.match(/^(\d+)[a-z](\d+)$/); // 4P01
        if (s) return { or: c.toUpperCase(), l: s[1], t: parseInt(s[2], 10).toString() };
        return null;
    }

    document.getElementById('startBtn').addEventListener('click', async () => {
        const rotFile = document.getElementById('rotTxt').files[0];
        const pdfFile = document.getElementById('pdfFile').files[0];
        if (!rotFile || !pdfFile) return alert("Seleziona entrambi i file!");

        const btn = document.getElementById('startBtn');
        const fill = document.getElementById('progressFill');
        const pBar = document.getElementById('pBar');
        
        btn.disabled = true;
        pBar.style.display = "block";
        document.getElementById('log').innerText = "Inizio analisi...";

        try {
            const rotText = await rotFile.text();
            const codiciRaw = rotText.match(/([a-zA-Z0-9]+)/g) || [];
            const mappa = Array.from(new Set(codiciRaw.map(c => JSON.stringify(parseCodice(c))))).map(s => JSON.parse(s)).filter(x => x !== null);
            
            addLog("Codici unici da cercare: " + mappa.length);

            const arrayBuffer = await pdfFile.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            let dbTurni = {};

            for (let i = 1; i <= pdf.numPages; i++) {
                fill.style.width = (i / pdf.numPages * 100) + "%";
                
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                
                // --- NOVITÀ: Ordinamento spaziale degli elementi ---
                const items = content.items.sort((a, b) => {
                    if (Math.abs(a.transform[5] - b.transform[5]) > 5) return b.transform[5] - a.transform[5];
                    return a.transform[4] - b.transform[4];
                });
                
                const text = items.map(item => item.str).join(" ").replace(/\s+/g, " ");

                const lM = text.match(/Linea:?\s*([a-z0-9.]+)/i);
                const tM = text.match(/TURNO:?\s*(\d+)/i);

                if (lM && tM) {
                    const lP = lM[1].toLowerCase().split('.')[0];
                    const tP = parseInt(tM[1], 10).toString();
                    const targets = mappa.filter(c => c.l.toLowerCase() === lP && c.t === tP);

                    if (targets.length > 0) {
                        // Estrazione sicura basata sulla posizione delle parole chiave
                        const indexMonta = text.indexOf("MONTA");
                        const indexSmonta = text.indexOf("SMONTA");

                        if (indexMonta !== -1 && indexSmonta !== -1) {
                            const zonaMonta = text.substring(indexMonta, indexSmonta);
                            const zonaSmonta = text.substring(indexSmonta);

                            const mO = zonaMonta.match(/(\d{1,2}\.\d{2})/);
                            const sO = zonaSmonta.match(/(\d{1,2}\.\d{2})/);

                            if (mO && sO) {
                                targets.forEach(t => {
                                    dbTurni[t.or] = {
                                        inizio: mO[0].replace('.', ':'),
                                        luogoInizio: pulisciLuogo(zonaMonta),
                                        fine: sO[0].replace('.', ':'),
                                        luogoFine: pulisciLuogo(zonaSmonta)
                                    };
                                    addLog("OK: " + t.or);
                                });
                            }
                        }
                    }
                }
                if (i % 5 === 0) await new Promise(r => setTimeout(r, 1));
            }

            if (Object.keys(dbTurni).length > 0) {
                const blob = new Blob([JSON.stringify(dbTurni, null, 2)], { type: "application/json" });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = "database_turni.json";
                a.click();
                addLog("\nSUCCESSO! File scaricato.");
            } else {
                addLog("\nERRORE: Nessun turno trovato. Verifica i nomi delle linee nel PDF.");
            }

        } catch (e) { addLog("ERRORE: " + e.message); }
        btn.disabled = false;
    });
</script>
</body>
</html>
