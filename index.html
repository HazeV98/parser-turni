<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parser Turni ATVO v2.7</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f0f2f5; }
        .container { max-width: 850px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h1 { color: #1a73e8; text-align: center; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .upload-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .box { border: 2px dashed #ccc; padding: 20px; border-radius: 10px; text-align: center; background: #fafafa; }
        button { background: #1a73e8; color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; width: 100%; font-size: 1.1rem; font-weight: bold; }
        #log { margin-top: 20px; padding: 15px; background: #1e1e1e; color: #00ff00; border-radius: 8px; font-family: 'Consolas', monospace; font-size: 0.85rem; height: 350px; overflow-y: auto; white-space: pre-wrap; }
        .progress { height: 10px; background: #eee; border-radius: 5px; margin-bottom: 10px; overflow: hidden; display: none; }
        #bar { height: 100%; background: #4caf50; width: 0%; transition: 0.1s; }
    </style>
</head>
<body>

<div class="container">
    <h1>Parser Turni v2.7 - Ultra Compatibility</h1>
    
    <div class="upload-section">
        <div class="box"><label>1. <b>rotazioni.txt</b></label><br><br><input type="file" id="rotTxt" accept=".txt"></div>
        <div class="box"><label>2. <b>PDF Turni</b></label><br><br><input type="file" id="pdfFile" accept="application/pdf"></div>
    </div>

    <div class="progress" id="pDiv"><div id="bar"></div></div>
    <button id="startBtn">Inizia Scansione Totale</button>
    <div id="log">Pronto.</div>
</div>

<script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    function addLog(msg) {
        const l = document.getElementById('log');
        l.innerText += "\n> " + msg;
        l.scrollTop = l.scrollHeight;
    }

    // Pulisce il luogo eliminando TUTTE le scorie tecniche tipiche del PDF ATVO
    function pulisciLuogo(testo) {
        if(!testo) return "";
        return testo
            .replace(/MONTA|SMONTA|alle|DURATA|Servizio|Validità|Tipologia|INTERO|PICCOLE|UNITA'|Valid\.|Serv\.|F\.TE|P\.LE|P\.ROMA|[\d]{1,2}\.[\d]{2}|[:.\-_]{2,}/gi, (match) => {
                // Teniamo F.TE e P.LE se sono parte del luogo reale
                if(/F\.TE|P\.LE|P\.ROMA/i.test(match)) return match;
                return "";
            })
            .split(/Validità|Tipologia|DURATA/i)[0] // Taglio netto se appaiono queste parole
            .replace(/\s+/g, ' ')
            .trim();
    }

    function parseCodice(c) {
        c = c.toLowerCase().trim();
        if (c === "disp") return null;
        // Supporto per: 4p01, m204, 1c11, co03
        let match = c.match(/^([a-z0-9]+?)([0-9]+)$/i);
        if (match) {
            return { or: c.toUpperCase(), l: match[1], t: parseInt(match[2], 10).toString() };
        }
        return null;
    }

    document.getElementById('startBtn').addEventListener('click', async () => {
        const rotFile = document.getElementById('rotTxt').files[0];
        const pdfFile = document.getElementById('pdfFile').files[0];
        if(!rotFile || !pdfFile) return alert("Carica entrambi i file");

        document.getElementById('pDiv').style.display = "block";
        const log = document.getElementById('log');
        log.innerText = "Analisi rotazioni...";

        const rotText = await rotFile.text();
        const codiciRaw = rotText.match(/([a-zA-Z0-9]+)/g) || [];
        const mappa = Array.from(new Set(codiciRaw.map(c => JSON.stringify(parseCodice(c))))).map(s => JSON.parse(s)).filter(x => x !== null);
        
        addLog("Cercando " + mappa.length + " codici univoci...");

        const arrayBuffer = await pdfFile.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
        let dbTurni = {};

        for (let i = 1; i <= pdf.numPages; i++) {
            document.getElementById('bar').style.width = (i/pdf.numPages*100) + "%";
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            
            // Uniamo il testo senza ordinamento spaziale rigido per non perdere pezzi
            const rawText = content.items.map(item => item.str).join(" ");
            const text = rawText.replace(/\s+/g, " ");

            // Ricerca Linea e Turno molto più permissiva
            const lM = text.match(/Linea[:\s]+([A-Z0-9.]+)/i);
            const tM = text.match(/TURNO[:\s]+(\d+)/i);

            if (lM && tM) {
                const lP = lM[1].toLowerCase().split('.')[0];
                const tP = parseInt(tM[1], 10).toString();
                
                const targets = mappa.filter(c => c.l.toLowerCase() === lP && c.t === tP);

                if (targets.length > 0) {
                    // Dividiamo la pagina in zona MONTA e zona SMONTA
                    const indexS = text.indexOf("SMONTA");
                    if (indexS !== -1) {
                        const zonaM = text.substring(0, indexS);
                        const zonaS = text.substring(indexS);

                        // Estrazione Orari (formato HH.mm)
                        const oraM = zonaM.match(/(\d{1,2}\.\d{2})/);
                        const oraS = zonaS.match(/(\d{1,2}\.\d{2})/);

                        if (oraM && oraS) {
                            targets.forEach(t => {
                                // Il luogo è ciò che sta tra la parola MONTA e l'orario
                                const luogoM = zonaM.match(/MONTA\s+(?:alle\s+)?(.*?)(?=\s\d{1,2}\.\d{2})/i);
                                const luogoS = zonaS.match(/SMONTA\s+(?:alle\s+)?(.*?)(?=\s\d{1,2}\.\d{2})/i);

                                dbTurni[t.or] = {
                                    inizio: oraM[0].replace('.', ':'),
                                    luogoInizio: pulisciLuogo(luogoM ? luogoM[1] : ""),
                                    fine: oraS[0].replace('.', ':'),
                                    luogoFine: pulisciLuogo(luogoS ? luogoS[1] : "")
                                };
                                addLog("TROVATO: " + t.or);
                            });
                        }
                    }
                }
            }
            if (i % 10 === 0) await new Promise(r => setTimeout(r, 1));
        }

        if (Object.keys(dbTurni).length > 0) {
            const blob = new Blob([JSON.stringify(dbTurni, null, 2)], { type: "application/json" });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = "database_turni.json";
            a.click();
            addLog("\nFINE! Database generato con " + Object.keys(dbTurni).length + " turni.");
        } else {
            addLog("\nNESSUN MATCH. Prova a controllare se il PDF è leggibile (seleziona il testo con il mouse nel PDF).");
        }
    });
</script>
</body>
</html>
