<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parser Turni ACTV v1.1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        :root { --primary: #00796b; --primary-dark: #004d40; --bg: #eef2f5; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; padding: 15px; background: var(--bg); margin: 0; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        h1 { color: var(--primary); text-align: center; border-bottom: 3px solid #b2dfdb; padding-bottom: 10px; font-size: 1.8rem; }
        
        .upload-section { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 15px; 
            margin: 20px 0; 
        }
        
        .box { 
            border: 2px dashed var(--primary); 
            padding: 25px 15px; 
            border-radius: 10px; 
            text-align: center; 
            background: #fafcfc; 
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        .box.drag-over { background: #e0f2f1; border-color: var(--primary-dark); transform: scale(1.02); }
        .box label { cursor: pointer; display: block; font-weight: 600; margin-bottom: 10px; color: var(--primary-dark); }
        .box input { position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer; }
        .file-name { display: block; margin-top: 10px; font-size: 0.85rem; color: #666; font-style: italic; }

        button { 
            background: var(--primary); 
            color: white; 
            border: none; 
            padding: 16px; 
            border-radius: 8px; 
            cursor: pointer; 
            width: 100%; 
            font-size: 1.1rem; 
            font-weight: bold; 
            transition: 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        button:hover { background: var(--primary-dark); }
        button:active { transform: translateY(1px); }

        #log { 
            margin-top: 20px; 
            padding: 15px; 
            background: #263238; 
            color: #80cbc4; 
            border-radius: 8px; 
            font-family: 'Courier New', monospace; 
            font-size: 0.85rem; 
            height: 300px; 
            overflow-y: auto; 
            border: 1px solid #10191d;
        }
        .progress { height: 8px; background: #eceff1; border-radius: 4px; margin-bottom: 15px; overflow: hidden; display: none; }
        #bar { height: 100%; background: #26a69a; width: 0%; transition: 0.2s; }
        
        .stat-box { 
            display: flex; 
            flex-wrap: wrap;
            justify-content: space-around; 
            margin-top: 15px; 
            gap: 10px;
            font-weight: bold; 
            color: var(--primary-dark); 
        }

        @media (max-width: 600px) {
            h1 { font-size: 1.4rem; }
            .box { padding: 20px 10px; }
            button { padding: 14px; font-size: 1rem; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Parser Turni ACTV v1.1</h1>
    
    <div class="upload-section">
        <div class="box" id="drop-zone-rot">
            <label>1. Carica <b>rotazioni.json</b></label>
            <span class="file-name" id="name-rot">Nessun file selezionato</span>
            <input type="file" id="rotJson" accept=".json">
        </div>
        <div class="box" id="drop-zone-pdf">
            <label>2. Carica <b>PDF Turni</b></label>
            <span class="file-name" id="name-pdf">Nessun file selezionato</span>
            <input type="file" id="pdfFile" accept="application/pdf">
        </div>
    </div>

    <div class="progress" id="pDiv"><div id="bar"></div></div>
    <button id="startBtn">Avvia Estrazione Dati</button>
    
    <div class="stat-box">
        <span id="statTot">Codici: 0</span>
        <span id="statTrovati">Trovati: 0</span>
    </div>
    
    <div id="log">Trascina i file o clicca sui riquadri per iniziare.</div>
</div>

<script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    // Gestione visuale Drag and Drop e nomi file
    function setupDropZone(inputId, zoneId, nameId) {
        const input = document.getElementById(inputId);
        const zone = document.getElementById(zoneId);
        const nameLabel = document.getElementById(nameId);

        input.addEventListener('change', () => {
            if(input.files[0]) nameLabel.innerText = input.files[0].name;
        });

        ['dragover', 'dragenter'].forEach(evt => {
            zone.addEventListener(evt, (e) => { e.preventDefault(); zone.classList.add('drag-over'); });
        });
        ['dragleave', 'dragend', 'drop'].forEach(evt => {
            zone.addEventListener(evt, () => zone.classList.remove('drag-over'));
        });
    }

    setupDropZone('rotJson', 'drop-zone-rot', 'name-rot');
    setupDropZone('pdfFile', 'drop-zone-pdf', 'name-pdf');

    function addLog(msg, color = "#80cbc4") {
        const l = document.getElementById('log');
        const div = document.createElement('div');
        div.style.color = color;
        div.innerText = "> " + msg;
        l.appendChild(div);
        l.scrollTop = l.scrollHeight;
    }

    function pulisciLuogo(t) {
        if(!t) return "";
        return t.replace(/MONTA|SMONTA|alle|DURATA|Servizio|Validità|Tipologia|INTERO|PICCOLE|GRANDI|SPEZZATO|NOTTURNO|UNITA'|Nota|Indennità|[\d]{1,2}\.[\d]{2}|[:.\-_]{2,}/gi, "")
                .replace(/\s+/g, ' ').trim();
    }

    function matchLineeACTV(codPref, pdfLin) {
        const c = codPref.toUpperCase();
        const p = pdfLin.toUpperCase().replace(/\s+/g, '');
        if (c === "1C") return p === "1";
        if (c === "2C") return p === "2";
        if (c === "3P") return p === "3";
        if (c === "4P") return p === "4.1";
        if (c === "5P") return p === "5.1";
        if (c === "6P") return p === "6";
        if (c === "7P") return p === "7";
        if (c === "M1") return p === "M1";
        if (c === "M2") return p === "M2";
        return false;
    }

    function parseCodice(c) {
        if (!c || typeof c !== 'string') return null;
        c = c.toLowerCase().trim();
        if (c === "disp" || c.length < 3) return null;
        let match = c.match(/^(\d+[a-z]|[a-z]\d+|[a-z]{2,})(\d+)$/i);
        if (match) {
            return { or: c.toUpperCase(), pref: match[1].toUpperCase(), num: parseInt(match[2], 10).toString() };
        }
        return null;
    }

    document.getElementById('startBtn').addEventListener('click', async () => {
        const rotFile = document.getElementById('rotJson').files[0];
        const pdfFile = document.getElementById('pdfFile').files[0];
        if(!rotFile || !pdfFile) return alert("Per favore, carica entrambi i file!");

        document.getElementById('pDiv').style.display = "block";
        document.getElementById('log').innerHTML = "";
        
        // Estrazione codici da JSON (tutte le chiavi)
        let mappa = [];
        try {
            const rotData = JSON.parse(await rotFile.text());
            let codiciFlat = [];
            for (let key in rotData) {
                if (Array.isArray(rotData[key])) {
                    codiciFlat = codiciFlat.concat(rotData[key]);
                }
            }
            mappa = Array.from(new Set(codiciFlat.map(c => JSON.stringify(parseCodice(c)))))
                         .map(s => JSON.parse(s))
                         .filter(x => x !== null);
        } catch (e) {
            return alert("Errore nel formato del file JSON!");
        }
        
        document.getElementById('statTot').innerText = "Codici: " + mappa.length;
        addLog("Inizio analisi di " + mappa.length + " turni ACTV...");

        const arrayBuffer = await pdfFile.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
        let dbTurni = {};
        let trovatiCount = 0;

        for (let i = 1; i <= pdf.numPages; i++) {
            document.getElementById('bar').style.width = (i/pdf.numPages*100) + "%";
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            const cleanText = content.items.map(item => item.str).join(" ").replace(/\s+/g, " ");

            const turniNellaPagina = cleanText.split(/TURNO[:\s]+/i);

            for (let b = 1; b < turniNellaPagina.length; b++) {
                const bloccoTurno = turniNellaPagina[b];
                const numMatch = bloccoTurno.match(/^(\d+)/);
                if (!numMatch) continue;
                const pdfT = parseInt(numMatch[1], 10).toString();

                let pdfL = "";
                const linMatch = bloccoTurno.match(/LINEA[:\s]+([A-Z0-9.]+)/i);
                if (linMatch) {
                    pdfL = linMatch[1].trim();
                } else {
                    const globalLinMatch = cleanText.match(/Linea[:\s]+([A-Z0-9.]+)/i);
                    if (globalLinMatch) pdfL = globalLinMatch[1].trim();
                }

                if(pdfL && pdfT) {
                    const targets = mappa.filter(c => c.num === pdfT && matchLineeACTV(c.pref, pdfL));

                    if (targets.length > 0) {
                        const headerArea = bloccoTurno.split(/(?:Nota servizio|EQUIPAGGIO|LIN\s+TV)/i)[0];
                        const pairRegex = /([A-Z.\s'\/]{3,})\s+(\d{1,2}\.\d{2})/g;
                        let matches = [];
                        let m;
                        while ((m = pairRegex.exec(headerArea)) !== null) {
                            matches.push({ luogo: pulisciLuogo(m[1]), ora: m[2] });
                        }

                        if (matches.length >= 2) {
                            const start = matches[0];
                            const end = matches[matches.length - 1];

                            targets.forEach(t => {
                                if (!dbTurni[t.or]) {
                                    dbTurni[t.or] = {
                                        inizio: start.ora.replace('.', ':'),
                                        luogoInizio: start.luogo,
                                        fine: end.ora.replace('.', ':'),
                                        luogoFine: end.luogo
                                    };
                                    trovatiCount++;
                                    document.getElementById('statTrovati').innerText = "Trovati: " + trovatiCount;
                                    addLog("OK: " + t.or + " (" + pdfL + " T." + pdfT + ")", "#00e676");
                                }
                            });
                        }
                    }
                }
            }
        }

        if (Object.keys(dbTurni).length > 0) {
            const blob = new Blob([JSON.stringify(dbTurni, null, 2)], { type: "application/json" });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = "info_turni_actv.json";
            a.click();
            addLog("\nFINE! Creato database con " + trovatiCount + " turni.", "#18ffff");
        } else {
            addLog("\nNESSUN MATCH: Verifica la corrispondenza tra JSON e PDF.", "#ff5252");
        }
    });
</script>
</body>
</html>
